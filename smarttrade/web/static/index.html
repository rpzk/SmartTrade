<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SmartTrade • BingX</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 2rem; }
    header { display: flex; align-items: baseline; gap: 1rem; }
    .row { display: flex; gap: 1rem; flex-wrap: wrap; }
    section { border: 1px solid #ddd; border-radius: 8px; padding: 1rem; margin-top: 1rem; }
    pre { background: #f7f7f7; padding: 0.75rem; border-radius: 6px; overflow: auto; }
    label { font-weight: 600; }
    .muted { color: #666; }
    .error { color: #b00020; }
  </style>
</head>
<body>
  <header>
    <h1>SmartTrade</h1>
    <span class="muted">BingX • dados reais (sem mock)</span>
  </header>

  <div class="row">
    <div>
      <label for="symbol">Símbolo:</label>
      <select id="symbol">
        <option>BTC-USDT</option>
        <option>ETH-USDT</option>
        <option>SOL-USDT</option>
      </select>
    </div>
    <div>
      <label for="interval">Intervalo (perp klines):</label>
      <select id="interval">
        <option>1m</option>
        <option>5m</option>
        <option>15m</option>
        <option>1h</option>
        <option>4h</option>
        <option>1d</option>
      </select>
    </div>
    <div>
      <label for="limit">Limite:</label>
      <input id="limit" type="number" min="1" max="200" value="10" />
    </div>
    <div>
      <button id="refresh">Atualizar agora</button>
      <label class="muted"><input type="checkbox" id="auto" checked /> Auto (5s)</label>
    </div>
  </div>

  <section>
    <h2>Spot • Ticker 24h</h2>
    <div id="spot-error" class="error"></div>
    <pre id="spot">Carregando…</pre>
  </section>

  <section>
    <h2>Perp • Ticker</h2>
    <div id="swap-ticker-error" class="error"></div>
    <pre id="swap-ticker">Carregando…</pre>
  </section>

  <section>
    <h2>Perp • Klines</h2>
    <div id="swap-klines-error" class="error"></div>
    <canvas id="chart" height="220"></canvas>
    <pre id="swap-klines" style="margin-top: 0.5rem;">Carregando…</pre>
  </section>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@3.3.0/dist/chartjs-chart-financial.min.js"></script>
  <script>
    const $ = (id) => document.getElementById(id);

    async function getJSON(url) {
      const r = await fetch(url);
      if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
      return await r.json();
    }

    function fmt(obj) { return JSON.stringify(obj, null, 2); }

    let ws;
    let chart;

    function upsertCandle(dataset, c) {
      const t = c.time;
      const foundIdx = dataset.findIndex(x => x.x === t);
      const point = { x: t, o: +c.open, h: +c.high, l: +c.low, c: +c.close };
      if (foundIdx >= 0) dataset[foundIdx] = point; else dataset.push(point);
      dataset.sort((a,b) => a.x - b.x);
    }

    function ensureChart() {
      if (chart) return chart;
      const ctx = document.getElementById('chart');
      chart = new Chart(ctx, {
        type: 'candlestick',
        data: { datasets: [{ label: 'Perp Klines', data: [] }] },
        options: {
          parsing: false,
          plugins: { legend: { display: true } },
          scales: {
            x: { type: 'time', time: { unit: 'minute' }},
            y: { beginAtZero: false }
          }
        }
      });
      return chart;
    }

    async function loadAll() {
      const symbol = $("symbol").value;
      const interval = $("interval").value;
      const limit = $("limit").value;

      // Spot ticker
      try {
        $("spot-error").textContent = "";
        const spot = await getJSON(`/api/spot/ticker?symbol=${encodeURIComponent(symbol)}`);
        $("spot").textContent = fmt(spot);
      } catch (e) {
        $("spot-error").textContent = e.message;
      }

      // Swap ticker
      try {
        $("swap-ticker-error").textContent = "";
        const st = await getJSON(`/api/swap/ticker?symbol=${encodeURIComponent(symbol)}`);
        $("swap-ticker").textContent = fmt(st);
      } catch (e) {
        $("swap-ticker-error").textContent = e.message;
      }

      // Swap klines (REST) - snapshot JSON abaixo do gráfico
      try {
        $("swap-klines-error").textContent = "";
        const kl = await getJSON(`/api/swap/klines?symbol=${encodeURIComponent(symbol)}&interval=${encodeURIComponent(interval)}&limit=${encodeURIComponent(limit)}`);
        $("swap-klines").textContent = fmt(kl);
        const ch = ensureChart();
        ch.data.datasets[0].data = kl.map(c => ({ x: c.time, o: +c.open, h: +c.high, l: +c.low, c: +c.close }));
        ch.update();
      } catch (e) {
        $("swap-klines-error").textContent = e.message;
      }
    }

    $("refresh").addEventListener("click", loadAll);
    ["symbol","interval","limit"].forEach(id => $(id).addEventListener("change", loadAll));

    let timer = null;
    function setupAuto() {
      if ($("auto").checked) {
        if (!timer) timer = setInterval(loadAll, 5000);
      } else {
        if (timer) { clearInterval(timer); timer = null; }
      }
    }
    $("auto").addEventListener("change", setupAuto);

    // WebSocket live updates para klines (streaming via servidor)
    function connectWS() {
      if (ws) { try { ws.close(); } catch (_) {} }
      const symbol = $("symbol").value;
      const interval = $("interval").value;
      const proto = location.protocol === 'https:' ? 'wss' : 'ws';
      const url = `${proto}://${location.host}/ws/swap/klines?symbol=${encodeURIComponent(symbol)}&interval=${encodeURIComponent(interval)}`;
      ws = new WebSocket(url);
      ws.onopen = () => { /* ok */ };
      ws.onmessage = (ev) => {
        try {
          const msg = JSON.parse(ev.data);
          if (msg.type === 'snapshot') {
            const ch = ensureChart();
            ch.data.datasets[0].data = (msg.data || []).map(c => ({ x: c.time, o: +c.open, h: +c.high, l: +c.low, c: +c.close }));
            ch.update();
          } else if (msg.type === 'kline') {
            const ch = ensureChart();
            upsertCandle(ch.data.datasets[0].data, msg.data);
            ch.update();
          }
        } catch (e) { /* ignore */ }
      };
      ws.onclose = () => { setTimeout(connectWS, 1500); };
      ws.onerror = () => { try { ws.close(); } catch (_) {} };
    }

    // Primeiro load + ativa auto e WS
    loadAll();
    setupAuto();
    connectWS();
  </script>
</body>
</html>
