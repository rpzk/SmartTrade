<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SmartTrade • BingX</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 2rem; background: #f5f6fb; color: #222; }
    header { display: flex; align-items: baseline; gap: 1rem; flex-wrap: wrap; }
    .row { display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 1rem; }
    section { background: #fff; border: 1px solid #e2e6f0; border-radius: 12px; padding: 1.25rem; margin-top: 1.5rem; box-shadow: 0 1px 2px rgb(15 23 42 / 8%); }
    label { font-weight: 600; }
    select, input, button { padding: 0.45rem 0.75rem; border-radius: 8px; border: 1px solid #cbd5f5; background: #fff; font: inherit; }
    button { background: #1d4ed8; color: #fff; cursor: pointer; border: none; transition: background 0.2s ease; }
    button:hover { background: #1e40af; }
    .muted { color: #666; }
    .error { color: #b00020; font-weight: 600; margin-bottom: 0.5rem; }
    .cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(170px, 1fr)); gap: 1rem; }
    .card { background: linear-gradient(180deg, #f8fafc 0%, #fff 100%); border: 1px solid #dbe2ff; border-radius: 12px; padding: 1rem; min-height: 110px; display: flex; flex-direction: column; justify-content: space-between; }
    .card h3 { margin: 0 0 0.35rem 0; font-size: 0.95rem; color: #475569; }
    .card .value { font-size: 1.45rem; font-weight: 700; }
    .card .value.positive { color: #059669; }
    .card .value.negative { color: #dc2626; }
    .delta { display: flex; align-items: center; gap: 0.35rem; font-weight: 600; }
    canvas { background: #fff; border-radius: 10px; border: 1px solid #dbe2ff; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; font-size: 0.9rem; }
    th, td { padding: 0.55rem 0.75rem; text-align: right; border-bottom: 1px solid #eef2ff; }
    th { text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.04em; color: #64748b; }
    td:first-child, th:first-child { text-align: left; }
    details { margin-top: 0.75rem; }
    details summary { cursor: pointer; font-weight: 600; color: #1d4ed8; }
    pre { background: #0f172a; color: #e2e8f0; padding: 0.75rem; border-radius: 8px; overflow: auto; font-size: 0.85rem; }
  </style>
</head>
<body>
  <header>
    <h1>SmartTrade</h1>
    <span class="muted">BingX • dados reais (sem mock)</span>
  </header>

  <div class="row">
    <div>
      <label for="symbol">Símbolo:</label>
      <select id="symbol">
        <option>BTC-USDT</option>
        <option>ETH-USDT</option>
        <option>SOL-USDT</option>
      </select>
    </div>
    <div>
      <label for="interval">Intervalo (perp klines):</label>
      <select id="interval">
        <option>1m</option>
        <option>5m</option>
        <option>15m</option>
        <option>1h</option>
        <option>4h</option>
        <option>1d</option>
      </select>
    </div>
    <div>
      <label for="limit">Limite:</label>
      <input id="limit" type="number" min="1" max="200" value="10" />
    </div>
    <div>
      <button id="refresh">Atualizar agora</button>
      <label class="muted"><input type="checkbox" id="auto" checked /> Auto (5s)</label>
    </div>
  </div>

  <section>
    <h2>Spot • Ticker 24h</h2>
    <div id="spot-error" class="error"></div>
    <div id="spot-card" class="cards">
      <div class="card"><h3>Status</h3><span class="muted">Carregando…</span></div>
    </div>
    <details>
      <summary>Ver JSON</summary>
      <pre id="spot-raw">Carregando…</pre>
    </details>
  </section>

  <section>
    <h2>Perp • Ticker</h2>
    <div id="swap-ticker-error" class="error"></div>
    <div id="swap-card" class="cards">
      <div class="card"><h3>Status</h3><span class="muted">Carregando…</span></div>
    </div>
    <details>
      <summary>Ver JSON</summary>
      <pre id="swap-raw">Carregando…</pre>
    </details>
  </section>

  <section>
    <h2>Perp • Klines</h2>
    <div id="swap-klines-error" class="error"></div>
    <canvas id="chart" height="220"></canvas>
    <table id="klines-table">
      <thead>
        <tr>
          <th>Horário</th>
          <th>Aber.</th>
          <th>Máx.</th>
          <th>Mín.</th>
          <th>Fech.</th>
          <th>Volume</th>
        </tr>
      </thead>
      <tbody>
        <tr><td colspan="6" class="muted">Carregando…</td></tr>
      </tbody>
    </table>
    <details>
      <summary>Ver JSON</summary>
      <pre id="swap-klines">Carregando…</pre>
    </details>
  </section>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1/dist/chartjs-adapter-luxon.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@3.3.0/dist/chartjs-chart-financial.min.js"></script>
  <script>
    const $ = (id) => document.getElementById(id);
    const num = (value) => {
      const parsed = Number(value);
      return Number.isFinite(parsed) ? parsed : null;
    };
    const fmtCurrency = (value) => {
      const parsed = num(value);
      return parsed === null ? '—' : parsed.toLocaleString('pt-BR', { style: 'currency', currency: 'USD' });
    };
    const fmtNumber = (value, digits = 2) => {
      const parsed = num(value);
      return parsed === null ? '—' : parsed.toLocaleString('pt-BR', { minimumFractionDigits: digits, maximumFractionDigits: digits });
    };
    const fmtPercent = (value) => {
      const parsed = num(value);
      if (parsed === null) return '—';
      return `${parsed > 0 ? '+' : ''}${parsed.toFixed(2)}%`;
    };

    async function getJSON(url) {
      const r = await fetch(url);
      if (!r.ok) throw new Error(`${r.status} ${r.statusText}`);
      return await r.json();
    }

    function fmt(obj) { return JSON.stringify(obj, null, 2); }

    function renderSpotCard(spot) {
      const change = num(spot.price_change_percent);
      const changeClass = change === null ? '' : change >= 0 ? 'positive' : 'negative';
      return `
        <div class="card">
          <h3>${spot.symbol.replace('-', ' / ')}</h3>
          <span class="value">${fmtCurrency(spot.last_price)}</span>
          <span class="muted">Abertura: ${fmtCurrency(spot.open_price)}</span>
        </div>
        <div class="card">
          <h3>Variação 24h</h3>
          <span class="value ${changeClass}">${fmtPercent(spot.price_change_percent)}</span>
          <span class="muted">Alta: ${fmtCurrency(spot.high_price)} • Baixa: ${fmtCurrency(spot.low_price)}</span>
        </div>
        <div class="card">
          <h3>Volume 24h</h3>
          <span class="value">${fmtNumber(spot.volume, 0)}</span>
          <span class="muted">Quote: ${fmtNumber(spot.quote_volume, 0)}</span>
        </div>
      `;
    }

    function renderSwapCard(ticker) {
      const change = num(ticker.price_change_percent);
      const changeClass = change === null ? '' : change >= 0 ? 'positive' : 'negative';
      return `
        <div class="card">
          <h3>${ticker.symbol.replace('-', ' / ')}</h3>
          <span class="value">${fmtCurrency(ticker.last_price)}</span>
          <span class="muted">Δ Absoluto: ${fmtNumber(ticker.price_change)}</span>
        </div>
        <div class="card">
          <h3>Variação 24h</h3>
          <span class="value ${changeClass}">${fmtPercent(ticker.price_change_percent)}</span>
          <span class="muted">Alta: ${fmtCurrency(ticker.high_price)} • Baixa: ${fmtCurrency(ticker.low_price)}</span>
        </div>
        <div class="card">
          <h3>Volume 24h</h3>
          <span class="value">${fmtNumber(ticker.volume, 0)}</span>
          <span class="muted">Último preço: ${fmtCurrency(ticker.last_price)}</span>
        </div>
      `;
    }

    function renderKlinesTable(rows) {
      if (!Array.isArray(rows) || !rows.length) {
        return '<tr><td colspan="6" class="muted">Sem dados para exibir.</td></tr>';
      }
      return rows.slice().reverse().map(candle => {
        const date = luxon.DateTime.fromMillis(candle.time).toLocaleString(luxon.DateTime.DATETIME_SHORT_WITH_SECONDS);
        return `
          <tr>
            <td>${date}</td>
            <td>${fmtCurrency(candle.open)}</td>
            <td>${fmtCurrency(candle.high)}</td>
            <td>${fmtCurrency(candle.low)}</td>
            <td>${fmtCurrency(candle.close)}</td>
            <td>${fmtNumber(candle.volume, 3)}</td>
          </tr>
        `;
      }).join('');
    }

    let ws;
    let chart;

    function upsertCandle(dataset, c) {
      const t = c.time;
      const foundIdx = dataset.findIndex(x => x.x === t);
  const point = { x: t, o: +c.open, h: +c.high, l: +c.low, c: +c.close, v: +c.volume };
      if (foundIdx >= 0) dataset[foundIdx] = point; else dataset.push(point);
      dataset.sort((a,b) => a.x - b.x);
    }

    function ensureChart() {
      if (chart) return chart;
      const ctx = document.getElementById('chart');
      chart = new Chart(ctx, {
        type: 'candlestick',
        data: { datasets: [{ label: 'Perp Klines', data: [] }] },
        options: {
          parsing: false,
          plugins: { legend: { display: true } },
          scales: {
            x: { type: 'time', time: { unit: 'minute' }},
            y: { beginAtZero: false }
          }
        }
      });
      return chart;
    }

    async function loadAll() {
      const symbol = $("symbol").value;
      const interval = $("interval").value;
      const limit = $("limit").value;

      // Spot ticker
      try {
        $("spot-error").textContent = "";
        const spot = await getJSON(`/api/spot/ticker?symbol=${encodeURIComponent(symbol)}`);
        $("spot-card").innerHTML = renderSpotCard(spot);
        $("spot-raw").textContent = fmt(spot);
      } catch (e) {
        $("spot-error").textContent = e.message;
      }

      // Swap ticker
      try {
        $("swap-ticker-error").textContent = "";
        const st = await getJSON(`/api/swap/ticker?symbol=${encodeURIComponent(symbol)}`);
        $("swap-card").innerHTML = renderSwapCard(st);
        $("swap-raw").textContent = fmt(st);
      } catch (e) {
        $("swap-ticker-error").textContent = e.message;
      }

      // Swap klines (REST) - snapshot JSON abaixo do gráfico
      try {
        $("swap-klines-error").textContent = "";
        const kl = await getJSON(`/api/swap/klines?symbol=${encodeURIComponent(symbol)}&interval=${encodeURIComponent(interval)}&limit=${encodeURIComponent(limit)}`);
        $("swap-klines").textContent = fmt(kl);
        $("klines-table").querySelector('tbody').innerHTML = renderKlinesTable(kl);
  const ch = ensureChart();
  ch.data.datasets[0].data = kl.map(c => ({ x: c.time, o: +c.open, h: +c.high, l: +c.low, c: +c.close, v: +c.volume }));
        ch.update();
      } catch (e) {
        $("swap-klines-error").textContent = e.message;
      }
    }

    $("refresh").addEventListener("click", loadAll);
    ["symbol","interval","limit"].forEach(id => $(id).addEventListener("change", loadAll));

    let timer = null;
    function setupAuto() {
      if ($("auto").checked) {
        if (!timer) timer = setInterval(loadAll, 5000);
      } else {
        if (timer) { clearInterval(timer); timer = null; }
      }
    }
    $("auto").addEventListener("change", setupAuto);

    // WebSocket live updates para klines (streaming via servidor)
    function connectWS() {
      if (ws) { try { ws.close(); } catch (_) {} }
      const symbol = $("symbol").value;
      const interval = $("interval").value;
      const proto = location.protocol === 'https:' ? 'wss' : 'ws';
      const url = `${proto}://${location.host}/ws/swap/klines?symbol=${encodeURIComponent(symbol)}&interval=${encodeURIComponent(interval)}`;
      ws = new WebSocket(url);
      ws.onopen = () => { /* ok */ };
      ws.onmessage = (ev) => {
        try {
          const msg = JSON.parse(ev.data);
          if (msg.type === 'snapshot') {
            const ch = ensureChart();
            const rows = msg.data || [];
            $("swap-klines").textContent = fmt(rows);
            $("klines-table").querySelector('tbody').innerHTML = renderKlinesTable(rows);
            ch.data.datasets[0].data = rows.map(c => ({ x: c.time, o: +c.open, h: +c.high, l: +c.low, c: +c.close, v: +c.volume }));
            ch.update();
          } else if (msg.type === 'kline') {
            const ch = ensureChart();
            upsertCandle(ch.data.datasets[0].data, msg.data);
            ch.update();
            const dataset = ch.data.datasets[0].data.slice().map(d => ({ time: d.x, open: d.o, high: d.h, low: d.l, close: d.c, volume: d.v }));
            $("swap-klines").textContent = fmt(dataset);
            $("klines-table").querySelector('tbody').innerHTML = renderKlinesTable(dataset);
          }
        } catch (e) { /* ignore */ }
      };
      ws.onclose = () => { setTimeout(connectWS, 1500); };
      ws.onerror = () => { try { ws.close(); } catch (_) {} };
    }

    // Primeiro load + ativa auto e WS
    loadAll();
    setupAuto();
    connectWS();
  </script>
</body>
</html>
